name: Actualizar ramas desde main

on:
  push:
    branches: [ main ]

jobs:
  actualizar-ramas:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Configurar identidad de Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
      
      - name: Fusionar main en ramas secundarias
        run: |
          # Lista de ramas que deseas actualizar
          RAMAS_DESTINO="huggingface-ai-chatbot otra-rama otra-rama-mas"
          
          for rama in $RAMAS_DESTINO; do
            echo "‚è≥ Actualizando $rama con los cambios de main..."
            
            # Cambiar a la rama (crea rama local si no existe)
            git checkout -B $rama origin/$rama
            
            # Obtener cambios m√°s recientes para evitar conflictos
            git pull --no-rebase
            
            # Verificar si es necesario fusionar (validaci√≥n de seguridad)
            if git merge-base --is-ancestor main $rama; then
              echo "‚úÖ $rama ya est√° actualizada con main"
              continue
            fi
            
            # Intentar fusi√≥n (crea un commit de fusi√≥n)
            if git merge --no-edit --no-ff main; then
              echo "üîÄ Fusi√≥n exitosa de main en $rama"
              # Enviar los cambios
              git push origin $rama
              echo "üì§ Cambios enviados a $rama"
            else
              echo "‚ö†Ô∏è Conflicto de fusi√≥n en $rama - omitiendo"
              echo "‚ùó Necesitar√°s resolver los conflictos manualmente en $rama"
              # Solo abortar fusi√≥n si hay una en progreso
              if [ -f ".git/MERGE_HEAD" ]; then
                git merge --abort
              fi
              # Crear un issue en GitHub para notificar
              gh issue create --title "Conflicto de fusi√≥n en $rama" \
                --body "Fusi√≥n autom√°tica fallida. Por favor resuelve los conflictos entre main y $rama manualmente." \
                --label "conflicto-fusion"
            fi
          done
          
          # Volver a la rama main al finalizar
          git checkout main
